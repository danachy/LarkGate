<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” é£ä¹¦ OAuth æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        .container {
            background: #2a2a2a;
            padding: 2rem;
            border-radius: 1rem;
            border: 1px solid #444;
        }
        h1 {
            color: #66ccff;
            text-align: center;
            margin-bottom: 2rem;
        }
        .step {
            background: #333;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
            border-left: 4px solid #66ccff;
        }
        .step h3 {
            color: #66ccff;
            margin-top: 0;
        }
        .oauth-url {
            background: #444;
            padding: 1rem;
            border-radius: 0.5rem;
            word-break: break-all;
            font-family: monospace;
            margin: 1rem 0;
        }
        .oauth-link {
            display: inline-block;
            background: #0066cc;
            color: white;
            padding: 1rem 2rem;
            text-decoration: none;
            border-radius: 0.5rem;
            font-weight: 600;
            margin: 1rem 0;
            transition: background 0.2s;
        }
        .oauth-link:hover {
            background: #0052a3;
        }
        .status {
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            font-weight: 600;
        }
        .status.success {
            background: #1a3d1a;
            color: #44ff44;
            border: 1px solid #44ff44;
        }
        .status.error {
            background: #3d1a1a;
            color: #ff4444;
            border: 1px solid #ff4444;
        }
        .status.info {
            background: #1a1a3d;
            color: #66ccff;
            border: 1px solid #66ccff;
        }
        .code-block {
            background: #1e1e1e;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            overflow-x: auto;
            border: 1px solid #444;
        }
        .session-info {
            font-size: 0.9rem;
            color: #999;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” é£ä¹¦ OAuth æµç¨‹æµ‹è¯•</h1>
        
        <div class="step">
            <h3>æ­¥éª¤ 1: è·å–è®¤è¯ URL</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–é£ä¹¦ OAuth è®¤è¯é“¾æ¥ï¼š</p>
            <button onclick="getAuthUrl()" style="background: #0066cc; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer;">
                è·å–è®¤è¯ URL
            </button>
            <div id="authUrlContainer"></div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤ 2: å®Œæˆè®¤è¯</h3>
            <p>ç‚¹å‡»è®¤è¯é“¾æ¥ï¼Œåœ¨é£ä¹¦é¡µé¢å®Œæˆæˆæƒï¼Œç„¶åä¼šè‡ªåŠ¨è·³è½¬å›æœ¬é¡µé¢ã€‚</p>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤ 3: æŸ¥çœ‹è®¤è¯ç»“æœ</h3>
            <div id="authResult"></div>
            <div id="tokenInfo"></div>
        </div>

        <div class="session-info">
            <strong>Session ID:</strong> <span id="sessionId">æœªè·å–</span><br>
            <strong>å½“å‰çŠ¶æ€:</strong> <span id="currentStatus">ç­‰å¾…å¼€å§‹</span>
        </div>
    </div>

    <script>
        let sessionId = null;
        let eventSource = null;

        // ç”Ÿæˆéšæœº session ID
        function generateSessionId() {
            return 'oauth-test-' + Math.random().toString(36).substr(2, 9);
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            document.getElementById('currentStatus').textContent = message;
        }

        // è·å–è®¤è¯ URL
        async function getAuthUrl() {
            try {
                if (!sessionId) {
                    sessionId = generateSessionId();
                    document.getElementById('sessionId').textContent = sessionId;
                }

                updateStatus('æ­£åœ¨è·å–è®¤è¯ URL...', 'info');

                // è¿æ¥ SSE è·å– OAuth URL
                eventSource = new EventSource(`http://localhost:3000/sse?sessionId=${sessionId}`);
                
                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'metadata' && data.data.oauth_url) {
                            const oauthUrl = data.data.oauth_url;
                            
                            document.getElementById('authUrlContainer').innerHTML = `
                                <div class="status success">âœ… è®¤è¯ URL è·å–æˆåŠŸï¼</div>
                                <div class="oauth-url">${oauthUrl}</div>
                                <a href="${oauthUrl}" class="oauth-link" target="_blank">ğŸš€ å‰å¾€é£ä¹¦è®¤è¯</a>
                            `;
                            
                            updateStatus('è®¤è¯ URL å·²è·å–ï¼Œè¯·ç‚¹å‡»é“¾æ¥å®Œæˆè®¤è¯', 'success');
                            
                            // å…³é—­ SSE è¿æ¥
                            eventSource.close();
                        }
                        
                    } catch (error) {
                        console.error('è§£æ SSE æ•°æ®å¤±è´¥:', error);
                    }
                };
                
                eventSource.onerror = (error) => {
                    console.error('SSE è¿æ¥é”™è¯¯:', error);
                    document.getElementById('authUrlContainer').innerHTML = `
                        <div class="status error">âŒ æ— æ³•è¿æ¥åˆ° LarkGateï¼Œè¯·ç¡®ä¿æœåŠ¡æ­£åœ¨è¿è¡Œ</div>
                    `;
                    updateStatus('è¿æ¥å¤±è´¥', 'error');
                };

            } catch (error) {
                console.error('è·å–è®¤è¯ URL å¤±è´¥:', error);
                updateStatus('è·å–è®¤è¯ URL å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥ URL å‚æ•°ä¸­çš„è®¤è¯ç»“æœ
        function checkAuthResult() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                document.getElementById('authResult').innerHTML = `
                    <div class="status error">âŒ è®¤è¯å¤±è´¥: ${error}</div>
                `;
                updateStatus('è®¤è¯å¤±è´¥', 'error');
                return;
            }

            if (code && state) {
                document.getElementById('authResult').innerHTML = `
                    <div class="status success">âœ… è®¤è¯æˆåŠŸï¼</div>
                    <div class="code-block">
                        <strong>Authorization Code:</strong> ${code}<br>
                        <strong>State:</strong> ${state}
                    </div>
                `;
                updateStatus('è®¤è¯æˆåŠŸï¼Œæ­£åœ¨è·å–è®¿é—®ä»¤ç‰Œ...', 'success');

                // æå– session ID
                const stateSessionId = state.split('_').pop();
                if (stateSessionId) {
                    sessionId = stateSessionId;
                    document.getElementById('sessionId').textContent = sessionId;
                }

                // æ£€æŸ¥ä»¤ç‰ŒçŠ¶æ€
                checkTokenStatus();
            }
        }

        // æ£€æŸ¥ä»¤ç‰ŒçŠ¶æ€
        async function checkTokenStatus() {
            try {
                const response = await fetch(`http://localhost:3000/health`);
                const data = await response.json();
                
                document.getElementById('tokenInfo').innerHTML = `
                    <div class="status info">
                        <h4>ğŸ“‹ LarkGate çŠ¶æ€ä¿¡æ¯</h4>
                        <div class="code-block">
                            <strong>æœåŠ¡çŠ¶æ€:</strong> ${data.status}<br>
                            <strong>ç‰ˆæœ¬:</strong> ${data.version}<br>
                            <strong>è¿è¡Œæ—¶é—´:</strong> ${Math.floor(data.uptime)}ç§’<br>
                            <strong>æ€»ä¼šè¯æ•°:</strong> ${data.sessions?.totalSessions || 0}<br>
                            <strong>è®¤è¯ä¼šè¯æ•°:</strong> ${data.sessions?.authenticatedSessions || 0}
                        </div>
                    </div>
                `;

                updateStatus('OAuth æµç¨‹æµ‹è¯•å®Œæˆï¼', 'success');

            } catch (error) {
                console.error('è·å–ä»¤ç‰ŒçŠ¶æ€å¤±è´¥:', error);
                updateStatus('æ— æ³•è·å–ä»¤ç‰ŒçŠ¶æ€', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯ç»“æœ
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthResult();
        });
    </script>
</body>
</html>