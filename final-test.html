<!DOCTYPE html>
<html>
<head>
    <title>âœ… LarkGate æœ€ç»ˆéªŒè¯æµ‹è¯•</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #e0e0e0; padding: 20px; }
        .success { color: #44ff44; }
        .error { color: #ff4444; }
        .result { background: #2a2a2a; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸš€ LarkGate æœ€ç»ˆéªŒè¯æµ‹è¯•</h1>
    <div id="results"></div>
    
    <script>
        function addResult(test, status, details = '') {
            const div = document.createElement('div');
            div.className = 'result';
            div.innerHTML = `
                <span class="${status}">${status === 'success' ? 'âœ…' : 'âŒ'} ${test}</span>
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            document.getElementById('results').appendChild(div);
        }
        
        async function runTests() {
            addResult('å¼€å§‹æœ€ç»ˆéªŒè¯æµ‹è¯•...', 'success');
            
            // æµ‹è¯• 1: Health Check
            try {
                const response = await fetch('http://localhost:3000/health');
                const data = await response.json();
                addResult('Health Check', 'success', `çŠ¶æ€: ${data.status}, ç‰ˆæœ¬: ${data.version}`);
            } catch (error) {
                addResult('Health Check', 'error', error.message);
                return;
            }
            
            // æµ‹è¯• 2: SSE è¿æ¥
            let sseConnected = false;
            let sseDataReceived = false;
            
            try {
                const eventSource = new EventSource('http://localhost:3000/sse');
                
                const ssePromise = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('SSE è¿æ¥è¶…æ—¶'));
                    }, 5000);
                    
                    eventSource.onopen = () => {
                        sseConnected = true;
                        addResult('SSE è¿æ¥æ‰“å¼€', 'success');
                    };
                    
                    eventSource.onmessage = (event) => {
                        clearTimeout(timeout);
                        sseDataReceived = true;
                        
                        if (event.data.startsWith(':')) {
                            addResult('SSE è¿æ¥ç¡®è®¤', 'success', 'æ”¶åˆ°æœåŠ¡å™¨è¿æ¥ç¡®è®¤');
                        } else {
                            try {
                                const data = JSON.parse(event.data);
                                if (data.type === 'metadata') {
                                    addResult('SSE å…ƒæ•°æ®æ¥æ”¶', 'success', 
                                        `Session: ${data.data.session_id.substring(0, 8)}..., å·¥å…·æ•°é‡: ${data.data.tools.length}`);
                                }
                                if (data.type === 'capabilities') {
                                    addResult('SSE èƒ½åŠ›ä¿¡æ¯æ¥æ”¶', 'success', 
                                        `åè®®ç‰ˆæœ¬: ${data.data.protocolVersion}`);
                                }
                            } catch (e) {
                                addResult('SSE æ•°æ®è§£æ', 'error', e.message);
                            }
                        }
                        
                        // æ¥æ”¶åˆ°æ•°æ®åå…³é—­è¿æ¥
                        setTimeout(() => {
                            eventSource.close();
                            resolve();
                        }, 1000);
                    };
                    
                    eventSource.onerror = (error) => {
                        clearTimeout(timeout);
                        reject(new Error(`SSE é”™è¯¯, readyState: ${eventSource.readyState}`));
                    };
                });
                
                await ssePromise;
                addResult('SSE å®Œæ•´æµç¨‹', 'success', 'è¿æ¥ã€æ•°æ®æ¥æ”¶ã€å…³é—­ - å…¨éƒ¨æˆåŠŸ');
                
            } catch (error) {
                addResult('SSE è¿æ¥æµ‹è¯•', 'error', error.message);
            }
            
            // æµ‹è¯• 3: å·¥å…·åˆ—è¡¨
            try {
                const response = await fetch('http://localhost:3000/tools');
                const data = await response.json();
                addResult('å·¥å…·åˆ—è¡¨ API', 'success', `è·å–åˆ° ${data.tools.length} ä¸ªå·¥å…·`);
            } catch (error) {
                addResult('å·¥å…·åˆ—è¡¨ API', 'error', error.message);
            }
            
            // æµ‹è¯• 4: CORS é¢„æ£€
            try {
                const response = await fetch('http://localhost:3000/sse', {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/event-stream',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    addResult('CORS é¢„æ£€', 'success', 'è·¨åŸŸè¯·æ±‚æˆåŠŸ');
                } else {
                    addResult('CORS é¢„æ£€', 'error', `çŠ¶æ€ç : ${response.status}`);
                }
            } catch (error) {
                addResult('CORS é¢„æ£€', 'error', error.message);
            }
            
            addResult('ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success', 'å¦‚æœä¸Šè¿°æµ‹è¯•éƒ½é€šè¿‡ï¼Œè¯´æ˜ LarkGate SSE é—®é¢˜å·²å®Œå…¨ä¿®å¤');
        }
        
        // å¯åŠ¨æµ‹è¯•
        runTests();
    </script>
</body>
</html>